version: 2.1
#slack orb 0.2.28
#Create your key here: https://api.slack.com/incoming-webhooks
orbs:
description: A notification orb for slack. Submit messages to your slack channels.
commands:
  ## NOTIFY ##
  notify:
    description: Notify a slack channel with a custom message
    parameters:
      webhook:
        description: Enter either your Webhook value or use the CircleCI UI to add your token under the 'SLACK_WEBHOOK' env var
        type: string
        default: ${SLACK_WEBHOOK}
      message:
        type: string
        default: Your job on CircleCI has completed.
    steps:
      - run: 
          name: Slack Notification
          command: |
            # TODO: Check that SLACK_WEBHOOK exists
            echo Notifying Slack Channel
            curl -X POST -H 'Content-type:\ application/json' --data '{"text":"<< parameters.message >>"}' << parameters.webhook >>
  ## STATUS ##
  status:
    description: Send a status alert at the end of a job based on success or failure. Must be the last step in a job.
    parameters:
      webhook:
        description: Enter either your Webhook value or use the CircleCI UI to add your token under the 'SLACK_WEBHOOK' env var
        type: string
        default: ${SLACK_WEBHOOK}
      circletoken:
        description: Input either your CircleCI personal token [WARNING NEVER DO THIS], or use the CircleCI UI to add your token under the 'CIRCLECI_TOKEN' env var
        type: string
        default: ${CIRCLECI_TOKEN}
    steps:
      - run:
          name: Slack - Fetching status
          command: |
            SLACK_STATUS_FAIL="true"
            echo Job faulure status:\ $SLACK_STATUS_FAIL
          when: on_fail
      - run: 
          name: Slack - Status Alert Sent
          command: |
            echo Job faulure status:\ $SLACK_STATUS_FAIL
            if [ "SLACK_STATUS_FAIL" != "true" ]; then
                #If not failed
                curl -X POST -H 'Content-type:\ application/json' --data '{ "attachments": [ { "fallback": "Job completed successfully - '$CIRCLE_BUILD_URL'", "text": "Job has completed successfully", "fields": [ { "title": "Project", "value": "'$CIRCLE_PROJECT_REPONAME'", "short": true }, { "title": "Job Number", "value": "'$CIRCLE_BUILD_NUM'", "short": true } ], "actions": [ { "type": "button", "text": "Visit Job", "url": "'$CIRCLE_BUILD_URL'" } ], "color": "#1CBF43" } ] }' << parameters.webhook >>
            else
                #If Failed
                 curl -X POST -H 'Content-type:\ application/json' --data '{ "attachments": [ { "fallback": "A job has failed - '$CIRCLE_BUILD_URL'", "text": "A job has failed", "fields": [ { "title": "Project", "value": "'$CIRCLE_PROJECT_REPONAME'", "short": true }, { "title": "Job Number", "value": "'$CIRCLE_BUILD_NUM'", "short": true } ], "actions": [ { "type": "button", "text": "Visit Job", "url": "'$CIRCLE_BUILD_URL'" } ], "color": "#ed5c5c" } ] }' << parameters.webhook >>
            fi
          when: always